//! Mini Transformer ç¤ºä¾‹
//!
//! æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨è¿™ä¸ªä»é›¶å®ç°çš„ Transformer æ¨¡å‹ã€‚

use mini_transformer::{
    TransformerEncoder, TransformerClassifier, TransformerConfig, configs,
};

fn main() {
    println!("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    println!("â•‘     Mini Transformer - Rust å®ç°              â•‘");
    println!("â•‘     ä»é›¶å­¦ä¹  Transformer æ¶æ„                 â•‘");
    println!("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ç¤ºä¾‹ 1: ä½¿ç”¨é¢„è®¾é…ç½®åˆ›å»ºæ¨¡å‹
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    println!("ğŸ“¦ ç¤ºä¾‹ 1: ä½¿ç”¨é¢„è®¾é…ç½®");
    println!("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n");

    let mini_config = configs::mini();
    let encoder = TransformerEncoder::new(mini_config);

    println!("{}", encoder.info());

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ç¤ºä¾‹ 2: å‰å‘ä¼ æ’­
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    println!("\nğŸ”„ ç¤ºä¾‹ 2: å‰å‘ä¼ æ’­");
    println!("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n");

    // æ¨¡æ‹Ÿè¾“å…¥åºåˆ—ï¼ˆtoken IDsï¼‰
    let input_tokens = vec![5, 12, 23, 45, 67];
    println!("è¾“å…¥åºåˆ—: {:?}", input_tokens);

    // æ‰§è¡Œå‰å‘ä¼ æ’­
    let output = encoder.forward(&input_tokens, None);
    println!("è¾“å‡ºå½¢çŠ¶: {:?}", output.shape());
    println!("è¾“å‡ºèŒƒå›´: [{:.4}, {:.4}]",
        output.iter().cloned().fold(f32::INFINITY, f32::min),
        output.iter().cloned().fold(f32::NEG_INFINITY, f32::max),
    );

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ç¤ºä¾‹ 3: åºåˆ—åˆ†ç±»
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    println!("\nğŸ¯ ç¤ºä¾‹ 3: åºåˆ—åˆ†ç±»ä»»åŠ¡");
    println!("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n");

    // åˆ›å»ºä¸€ä¸ªåˆ†ç±»æ¨¡å‹ï¼ˆå‡è®¾æœ‰ 5 ä¸ªç±»åˆ«ï¼‰
    let n_classes = 5;
    let classifier = TransformerClassifier::new(
        TransformerConfig {
            vocab_size: 1000,
            d_model: 128,
            n_heads: 4,
            n_layers: 2,
            d_ff: 256,
            max_seq_len: 64,
            dropout: 0.1,
        },
        n_classes,
    );

    println!("åˆ†ç±»å™¨å‚æ•°æ€»æ•°: {}", classifier.param_count());

    // æµ‹è¯•æ ·æœ¬
    let test_samples = vec![
        vec![1, 2, 3, 4, 5],      // å¥å­ 1
        vec![10, 20, 30, 40, 50], // å¥å­ 2
    ];

    println!("\nåˆ†ç±»ç»“æœ:");
    for (i, sample) in test_samples.iter().enumerate() {
        let class = classifier.predict(sample);
        println!("  æ ·æœ¬ {} {:?} â†’ ç±»åˆ« {}", i + 1, sample, class);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ç¤ºä¾‹ 4: ä¸åŒå¤§å°çš„æ¨¡å‹å¯¹æ¯”
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    println!("\nğŸ“Š ç¤ºä¾‹ 4: æ¨¡å‹è§„æ¨¡å¯¹æ¯”");
    println!("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n");

    let configs = vec![
        ("Mini", configs::mini()),
        ("Base", configs::base()),
    ];

    println!("{:<10} {:<12} {:<10} {:<10} {:<15}",
        "æ¨¡å‹", "d_model", "å±‚æ•°", "å¤´æ•°", "å‚æ•°é‡"
    );
    println!("{}", "â”€".repeat(65));

    for (name, config) in configs {
        let encoder = TransformerEncoder::new(config);
        let params = encoder.param_count();

        println!("{:<10} {:<12} {:<10} {:<10} {:<15}",
            name,
            encoder.config().d_model,
            encoder.config().n_layers,
            encoder.config().n_heads,
            params
        );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ç¤ºä¾‹ 5: è‡ªå®šä¹‰é…ç½®
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    println!("\nâš™ï¸  ç¤ºä¾‹ 5: è‡ªå®šä¹‰é…ç½®");
    println!("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n");

    let custom_config = TransformerConfig {
        vocab_size: 5000,
        d_model: 256,
        n_heads: 8,
        n_layers: 4,
        d_ff: 512,
        max_seq_len: 128,
        dropout: 0.15,
    };

    let custom_encoder = TransformerEncoder::new(custom_config);
    println!("{}", custom_encoder.info());

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // æ³¨æ„æœºåˆ¶å¯è§†åŒ–ç¤ºä¾‹
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    println!("\nğŸ” æ³¨æ„æœºåˆ¶è¯´æ˜");
    println!("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n");
    println!("Multi-Head Self-Attention å·¥ä½œåŸç†:");
    println!("  1. è¾“å…¥åºåˆ—é€šè¿‡ Qã€Kã€V ä¸‰ä¸ªçº¿æ€§å˜æ¢");
    println!("  2. è®¡ç®—æ³¨æ„åŠ›åˆ†æ•°: Q Ã— K^T / âˆšd_k");
    println!("  3. åº”ç”¨ softmax å¾—åˆ°æ³¨æ„åŠ›æƒé‡");
    println!("  4. æƒé‡ä¹˜ä»¥ V å¾—åˆ°æ³¨æ„åŠ›è¾“å‡º");
    println!("  5. å¤šå¤´å¹¶è¡Œæ‰§è¡Œï¼Œæœ€åæ‹¼æ¥å¹¶çº¿æ€§å˜æ¢");
    println!("\næ®‹å·®è¿æ¥å’Œå±‚å½’ä¸€åŒ–:");
    println!("  - æ¯ä¸ªå­å±‚åéƒ½æœ‰æ®‹å·®è¿æ¥: x + Sublayer(x)");
    println!("  - ç„¶ååº”ç”¨ Layer Normalization");
    println!("  - è¿™æœ‰åŠ©äºæ¢¯åº¦æµåŠ¨å’Œè®­ç»ƒç¨³å®šæ€§");

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // æ€§èƒ½æµ‹è¯•
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    println!("\nâš¡ æ€§èƒ½æµ‹è¯•");
    println!("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n");

    use std::time::Instant;

    let test_encoder = TransformerEncoder::new(configs::mini());
    let test_input: Vec<usize> = (0..32).collect(); // 32 é•¿åº¦åºåˆ—
    let n_iterations = 100;

    let start = Instant::now();
    for _ in 0..n_iterations {
        let _ = test_encoder.forward(&test_input, None);
    }
    let duration = start.elapsed();

    println!("æ‰§è¡Œ {} æ¬¡å‰å‘ä¼ æ’­ (åºåˆ—é•¿åº¦: {}):", n_iterations, test_input.len());
    println!("  æ€»æ—¶é—´: {:?}", duration);
    println!("  å¹³å‡: {:.2} ms/æ¬¡", duration.as_millis() as f64 / n_iterations as f64);

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    println!("\nâœ… æ‰€æœ‰ç¤ºä¾‹è¿è¡Œå®Œæˆ!");
    println!("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
    println!("\nğŸ’¡ æç¤º:");
    println!("  - ä¿®æ”¹é…ç½®ä»¥åˆ›å»ºä¸åŒè§„æ¨¡çš„æ¨¡å‹");
    println!("  - å®ç°è®­ç»ƒå¾ªç¯ä»¥åœ¨å®é™…æ•°æ®ä¸Šè®­ç»ƒ");
    println!("  - æ·»åŠ ä¼˜åŒ–å™¨ï¼ˆAdamã€SGD ç­‰ï¼‰è¿›è¡Œå‚æ•°æ›´æ–°");
    println!("  - å®ç°æŸå¤±å‡½æ•°ï¼ˆäº¤å‰ç†µã€MSE ç­‰ï¼‰");
    println!("\nğŸ“š ä¸‹ä¸€æ­¥:");
    println!("  - é˜…è¯» src/attention.rs äº†è§£æ³¨æ„åŠ›æœºåˆ¶");
    println!("  - é˜…è¯» src/transformer.rs äº†è§£å®Œæ•´æ¶æ„");
    println!("  - è¿è¡Œ cargo test éªŒè¯å„ä¸ªç»„ä»¶");
}
