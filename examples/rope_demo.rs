//! RoPE (Rotary Position Embedding) æ¼”ç¤º
//!
//! å±•ç¤ºæ—‹è½¬ä½ç½®ç¼–ç çš„å·¥ä½œåŸç†å’Œæ•ˆæœ

use mini_transformer::{apply_rotary_pos_emb, apply_rope_batch, RoPEAttention, RoPEConfig};
use ndarray::Array2;

fn main() {
    println!("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    println!("â•‘     RoPE (Rotary Position Embedding) æ¼”ç¤º     â•‘");
    println!("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

    // ============================================================================
    // 1. RoPE åŸºæœ¬æ¦‚å¿µ
    // ============================================================================
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    println!("1. RoPE åŸºæœ¬æ¦‚å¿µ");
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

    println!("ä»€ä¹ˆæ˜¯ RoPE?");
    println!("  - RoPE = Rotary Position Embedding (æ—‹è½¬ä½ç½®ç¼–ç )");
    println!("  - é€šè¿‡æ—‹è½¬å‘é‡æ¥ç¼–ç ä½ç½®ä¿¡æ¯");
    println!("  - ç›¸æ¯”ç»å¯¹ä½ç½®ç¼–ç ï¼ŒRoPE èƒ½æ›´å¥½åœ°å»ºæ¨¡ç›¸å¯¹ä½ç½®\n");

    println!("æ ¸å¿ƒå…¬å¼:");
    println!("  Î¸_i = position * 10000^(-2i/d)");
    println!("  æ—‹è½¬: [x0*cos(Î¸) - x1*sin(Î¸), x0*sin(Î¸) + x1*cos(Î¸)]\n");

    println!("ä¼˜åŠ¿:");
    println!("  âœ… è‡ªç„¶åœ°è¡¨è¾¾ç›¸å¯¹ä½ç½®å…³ç³»");
    println!("  âœ… ä¿æŒå‘é‡èŒƒæ•°ä¸å˜ï¼ˆæ—‹è½¬ä¸æ”¹å˜é•¿åº¦ï¼‰");
    println!("  âœ… å¯ä»¥å¤–æ¨åˆ°æ›´é•¿çš„åºåˆ—");
    println!("  âœ… è®¡ç®—é«˜æ•ˆï¼Œä¸éœ€è¦é¢å¤–çš„ä½ç½®åµŒå…¥å‚æ•°\n");

    // ============================================================================
    // 2. å•ä¸ªä½ç½®çš„æ—‹è½¬æ¼”ç¤º
    // ============================================================================
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    println!("2. å•ä¸ªä½ç½®çš„æ—‹è½¬æ¼”ç¤º");
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

    // åˆ›å»ºä¸€ä¸ªç®€å•çš„æŸ¥è¯¢å‘é‡
    let q = Array2::from_shape_vec((1, 4), vec![1.0, 0.0, 2.0, 0.0]).unwrap();
    let k = Array2::from_shape_vec((1, 4), vec![0.5, 0.5, 1.0, 0.0]).unwrap();

    println!("åŸå§‹å‘é‡:");
    println!("  Q: [{}]", format_vector(&q.row(0).to_vec()));
    println!("  K: [{}]", format_vector(&k.row(0).to_vec()));
    println!("  Q èŒƒæ•°: {:.4}", compute_norm(&q.row(0).to_vec()));
    println!("  K èŒƒæ•°: {:.4}\n", compute_norm(&k.row(0).to_vec()));

    // åœ¨ä¸åŒä½ç½®åº”ç”¨ RoPE
    println!("åœ¨ä¸åŒä½ç½®åº”ç”¨ RoPE:");
    println!("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
    println!("â”‚ ä½ç½®     â”‚ Q (æ—‹è½¬å)          â”‚ K (æ—‹è½¬å)          â”‚ Q èŒƒæ•°   â”‚ K èŒƒæ•°   â”‚");
    println!("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤");

    for pos in [0, 1, 2, 5, 10].iter() {
        let (q_rot, k_rot) = apply_rotary_pos_emb(&q, &k, *pos);
        let q_norm = compute_norm(&q_rot.row(0).to_vec());
        let k_norm = compute_norm(&k_rot.row(0).to_vec());

        println!(
            "â”‚ {:8} â”‚ {:19} â”‚ {:19} â”‚ {:8.4} â”‚ {:8.4} â”‚",
            pos,
            format_vector(&q_rot.row(0).to_vec()),
            format_vector(&k_rot.row(0).to_vec()),
            q_norm,
            k_norm
        );
    }

    println!("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n");

    println!("ğŸ’¡ è§‚å¯Ÿ:");
    println!("   - ä½ç½®è¶Šå¤§ï¼Œæ—‹è½¬è§’åº¦è¶Šå¤§");
    println!("   - å‘é‡èŒƒæ•°ä¿æŒä¸å˜ï¼ˆæ—‹è½¬æ“ä½œï¼‰");
    println!("   - ä¸åŒä½ç½®çš„å‘é‡å¯é€šè¿‡ç›¸å¯¹è§’åº¦æ¯”è¾ƒ\n");

    // ============================================================================
    // 3. åºåˆ—çš„æ‰¹é‡æ—‹è½¬
    // ============================================================================
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    println!("3. åºåˆ—çš„æ‰¹é‡æ—‹è½¬");
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

    // åˆ›å»ºä¸€ä¸ªåºåˆ— (4ä¸ªtokenï¼Œæ¯ä¸ª4ç»´)
    let q_seq = Array2::from_shape_vec(
        (4, 4),
        vec![
            // token 0
            1.0, 0.0, 1.0, 0.0,
            // token 1
            0.0, 1.0, 0.0, 1.0,
            // token 2
            1.0, 1.0, 0.0, 0.0,
            // token 3
            0.0, 0.0, 1.0, 1.0,
        ],
    )
    .unwrap();

    let k_seq = Array2::from_shape_vec(
        (4, 4),
        vec![
            // token 0
            0.5, 0.5, 0.5, 0.5,
            // token 1
            1.0, 0.0, 1.0, 0.0,
            // token 2
            0.0, 1.0, 0.0, 1.0,
            // token 3
            1.0, 1.0, 1.0, 1.0,
        ],
    )
    .unwrap();

    println!("åŸå§‹åºåˆ—:");
    for i in 0..4 {
        println!("  Token {}: Q=[{}] K=[{}]", i, format_vector(&q_seq.row(i).to_vec()), format_vector(&k_seq.row(i).to_vec()));
    }
    println!();

    let (q_rot_seq, k_rot_seq) = apply_rope_batch(&q_seq, &k_seq);

    println!("æ—‹è½¬ååºåˆ—:");
    for i in 0..4 {
        println!(
            "  Token {}: Q=[{}] K=[{}]",
            i,
            format_vector(&q_rot_seq.row(i).to_vec()),
            format_vector(&k_rot_seq.row(i).to_vec())
        );
    }
    println!();

    // ============================================================================
    // 4. ç›¸å¯¹ä½ç½®å»ºæ¨¡æ¼”ç¤º
    // ============================================================================
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    println!("4. ç›¸å¯¹ä½ç½®å»ºæ¨¡æ¼”ç¤º");
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

    println!("RoPE çš„æ ¸å¿ƒä¼˜åŠ¿ï¼šç›¸å¯¹ä½ç½®æ„ŸçŸ¥");
    println!("ä¸åŒä½ç½®çš„å‘é‡ä¹‹é—´çš„å†…ç§¯åæ˜ äº†å®ƒä»¬çš„ç›¸å¯¹ä½ç½®\n");

    // åˆ›å»ºç›¸åŒçš„å‘é‡ï¼Œåœ¨ä¸åŒä½ç½®
    let base_vec = Array2::from_shape_vec((1, 4), vec![1.0, 0.0, 1.0, 0.0]).unwrap();
    let mut positions = vec![];
    let mut rotated_vecs = vec![];

    for pos in 0..5 {
        let (v, _) = apply_rotary_pos_emb(&base_vec, &base_vec, pos);
        positions.push(pos);
        rotated_vecs.push(v.row(0).to_vec());
    }

    println!("ç›¸åŒå‘é‡åœ¨ä¸åŒä½ç½®çš„å†…ç§¯:");
    println!("â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”");
    print!("â”‚       â”‚");

    for j in 0..5 {
        print!(" Pos{:2} â”‚", j);
    }
    println!();
    println!("â”œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤");

    for i in 0..5 {
        print!("â”‚ Pos{:2} â”‚", i);
        for j in 0..5 {
            let dot_product = dot_product(&rotated_vecs[i], &rotated_vecs[j]);
            print!(" {:.4} â”‚", dot_product);
        }
        println!();
    }

    println!("â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜\n");

    println!("ğŸ’¡ è§‚å¯Ÿ:");
    println!("   - å¯¹è§’çº¿ä¸º 1.0ï¼ˆè‡ªå·±å’Œè‡ªå·±ï¼‰");
    println!("   - è·ç¦»è¶Šè¿œï¼Œå†…ç§¯è¶Šå°ï¼ˆç›¸ä¼¼åº¦é™ä½ï¼‰");
    println!("   - è¿™ç§æ¨¡å¼ä½¿æ¨¡å‹èƒ½æ„ŸçŸ¥ç›¸å¯¹ä½ç½®\n");

    // ============================================================================
    // 5. å¤šå¤´æ³¨æ„åŠ›é…ç½®
    // ============================================================================
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    println!("5. å¤šå¤´æ³¨æ„åŠ›é…ç½®");
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

    // åˆ›å»º RoPE é…ç½®
    let config = RoPEConfig::new(128).with_head_dim(64);
    println!("RoPE é…ç½®:");
    println!("  d_model: {}", config.d_model);
    println!("  head_dim: {}\n", config.head_dim);

    // åˆ›å»ºå¤šå¤´ RoPE attention
    let rope_attn = RoPEAttention::new(128, 8);
    println!("å¤šå¤´ RoPE Attention:");
    println!("  d_model: {}", rope_attn.d_model);
    println!("  n_heads: {}", rope_attn.n_heads);
    println!("  head_dim: {}\n", rope_attn.head_dim);

    // ============================================================================
    // 6. ä¸ä¼ ç»Ÿä½ç½®ç¼–ç å¯¹æ¯”
    // ============================================================================
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    println!("6. ä¸ä¼ ç»Ÿä½ç½®ç¼–ç å¯¹æ¯”");
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

    println!("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
    println!("â”‚ ç‰¹æ€§            â”‚ ç»å¯¹ä½ç½®ç¼–ç       â”‚ RoPE             â”‚");
    println!("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤");
    println!("â”‚ å‚æ•°é‡          â”‚ éœ€è¦é¢å¤–çš„ä½ç½®è¡¨  â”‚ æ— é¢å¤–å‚æ•°       â”‚");
    println!("â”‚ ç›¸å¯¹ä½ç½®        â”‚ éšå¼å­¦ä¹           â”‚ æ˜¾å¼å»ºæ¨¡         â”‚");
    println!("â”‚ åºåˆ—é•¿åº¦å¤–æ¨    â”‚ å›°éš¾              â”‚ å®¹æ˜“             â”‚");
    println!("â”‚ è®¡ç®—å¤æ‚åº¦      â”‚ O(1) æŸ¥è¡¨         â”‚ O(d) æ—‹è½¬è®¡ç®—     â”‚");
    println!("â”‚ èŒƒæ•°ä¿æŒ        â”‚ ä¸ä¿è¯            â”‚ ä¿æŒä¸å˜         â”‚");
    println!("â”‚ ç°ä»£ LLM é‡‡ç”¨   â”‚ BERT              â”‚ GPT-3, LLaMA ç­‰  â”‚");
    println!("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n");

    // ============================================================================
    // 7. æŠ€æœ¯ç»†èŠ‚
    // ============================================================================
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    println!("7. æŠ€æœ¯ç»†èŠ‚");
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

    println!("1. æ—‹è½¬é¢‘ç‡è®¡ç®—:");
    println!("   - Î¸_i = position * 10000^(-2i/d)");
    println!("   - 10000 æ˜¯åŸºå‡†é¢‘ç‡ï¼ˆå¯è°ƒæ•´ï¼‰");
    println!("   - è¾ƒå°çš„ iï¼ˆä½ç»´ï¼‰å˜åŒ–æ…¢ï¼Œè¾ƒå¤§çš„ iï¼ˆé«˜ç»´ï¼‰å˜åŒ–å¿«\n");

    println!("2. 2D æ—‹è½¬:");
    println!("   - æ¯å¯¹ç»´åº¦ (x0, x1), (x2, x3), ... ç‹¬ç«‹æ—‹è½¬");
    println!("   - æ—‹è½¬çŸ©é˜µ: [[cos(Î¸), -sin(Î¸)], [sin(Î¸), cos(Î¸)]]");
    println!("   - è¿™æ˜¯ç­‰è·å˜æ¢ï¼Œä¿æŒå‘é‡é•¿åº¦\n");

    println!("3. ä¸ºä»€ä¹ˆæœ‰æ•ˆ?");
    println!("   - æ—‹è½¬åçš„å†…ç§¯: <R(Î¸1)q, R(Î¸2)k>");
    println!("   - åªä¸ç›¸å¯¹ä½ç½® (Î¸1 - Î¸2) æœ‰å…³");
    println!("   - ä½¿æ³¨æ„åŠ›æœºåˆ¶èƒ½æ„ŸçŸ¥ç›¸å¯¹ä½ç½®\n");

    println!("4. æ¨èé…ç½®:");
    println!("   - d_model: 128, 256, 512, 768, 1024, ...");
    println!("   - head_dim: d_model / n_heads (å¿…é¡»æ˜¯å¶æ•°)");
    println!("   - åŸºå‡†é¢‘ç‡: 10000 (æ ‡å‡†), 1000000 (é•¿åºåˆ—)\n");

    println!("5. å®ç°ç¤ºä¾‹:");
    println!("```rust");
    println!("use mini_transformer::{{RoPEConfig, apply_rope_batch}};");
    println!();
    println!("// åˆ›å»ºé…ç½®");
    println!("let config = RoPEConfig::new(512).with_head_dim(64);");
    println!();
    println!("// åº”ç”¨ RoPE");
    println!("let (q_rot, k_rot) = apply_rope_batch(&q, &k);");
    println!("```");

    println!();
    println!("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    println!("â•‘     æ¼”ç¤ºå®Œæˆï¼                               â•‘");
    println!("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

    println!("ğŸ’¡ å®è·µå»ºè®®:");
    println!("   - RoPE æ˜¯ç°ä»£ LLM çš„æ ‡å‡†é…ç½®");
    println!("   - æ¨èåœ¨æ‰€æœ‰æ–°çš„ Transformer æ¨¡å‹ä¸­ä½¿ç”¨");
    println!("   - ç‰¹åˆ«é€‚åˆé•¿åºåˆ—å»ºæ¨¡ï¼ˆ>512 tokensï¼‰");
    println!("   - ä¸å…¶ä»–ä½ç½®ç¼–ç ç›¸æ¯”ï¼Œæ€§èƒ½æå‡æ˜æ˜¾");
}

/// æ ¼å¼åŒ–å‘é‡æ˜¾ç¤º
fn format_vector(v: &[f32]) -> String {
    v.iter()
        .map(|x| format!("{:6.3}", x))
        .collect::<Vec<_>>()
        .join(", ")
}

/// è®¡ç®—å‘é‡èŒƒæ•°
fn compute_norm(v: &[f32]) -> f32 {
    v.iter().map(|x| x * x).sum::<f32>().sqrt()
}

/// è®¡ç®—å‘é‡å†…ç§¯
fn dot_product(a: &[f32], b: &[f32]) -> f32 {
    a.iter().zip(b.iter()).map(|(x, y)| x * y).sum::<f32>()
}
