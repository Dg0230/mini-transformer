//! CausalLM æ–‡æœ¬ç”Ÿæˆç¤ºä¾‹
//!
//! å±•ç¤º GPT-2 é£æ ¼çš„å› æœè¯­è¨€æ¨¡å‹ç”Ÿæˆæ–‡æœ¬

use mini_transformer::{CausalLM, CausalLMConfig};

fn main() {
    println!("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    println!("â•‘     CausalLM æ–‡æœ¬ç”Ÿæˆç¤ºä¾‹ (GPT-2 é£æ ¼)      â•‘");
    println!("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

    // ============================================================================
    // 1. CausalLM åŸºæœ¬æ¦‚å¿µ
    // ============================================================================
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    println!("1. CausalLM åŸºæœ¬æ¦‚å¿µ");
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

    println!("ä»€ä¹ˆæ˜¯ CausalLM?");
    println!("  - CausalLM = Causal Language Modelï¼ˆå› æœè¯­è¨€æ¨¡å‹ï¼‰");
    println!("  - Decoder-only æ¶æ„ï¼ˆç±»ä¼¼ GPT-2, GPT-3ï¼‰");
    println!("  - ä»å·¦åˆ°å³è‡ªå›å½’ç”Ÿæˆæ–‡æœ¬");
    println!("  - ä½¿ç”¨å› æœæ³¨æ„åŠ›ï¼ˆæ¯ä¸ªä½ç½®åªèƒ½çœ‹åˆ°ä¹‹å‰çš„ä½ç½®ï¼‰\n");

    println!("æ¶æ„ç‰¹ç‚¹:");
    println!("  âœ… æ— ç¼–ç å™¨ï¼Œåªæœ‰è§£ç å™¨");
    println!("  âœ… å› æœæ©ç ç¡®ä¿è‡ªå›å½’æ€§è´¨");
    println!("  âœ… RoPE ä½ç½®ç¼–ç ï¼ˆå¯é€‰ï¼‰");
    println!("  âœ… é€‚åˆæ–‡æœ¬ç”Ÿæˆä»»åŠ¡\n");

    // ============================================================================
    // 2. åˆ›å»ºæ¨¡å‹
    // ============================================================================
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    println!("2. åˆ›å»º CausalLM æ¨¡å‹");
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

    // ä½¿ç”¨å°å‹é…ç½®å¿«é€Ÿæ¼”ç¤º
    let config = CausalLMConfig::small();
    println!("æ¨¡å‹é…ç½®:");
    println!("  è¯æ±‡è¡¨å¤§å°: {}", config.vocab_size);
    println!("  æ¨¡å‹ç»´åº¦: {}", config.d_model);
    println!("  æ³¨æ„åŠ›å¤´æ•°: {}", config.n_heads);
    println!("  å±‚æ•°: {}", config.n_layers);
    println!("  å‰é¦ˆç»´åº¦: {}", config.d_ff);
    println!("  æœ€å¤§åºåˆ—é•¿åº¦: {}", config.max_seq_len);
    println!("  ä½¿ç”¨ RoPE: {}\n", config.use_rope);

    let model = CausalLM::new(config);
    println!("âœ“ æ¨¡å‹åˆ›å»ºæˆåŠŸï¼\n");

    // ============================================================================
    // 3. è´ªå©ªè§£ç ç¤ºä¾‹
    // ============================================================================
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    println!("3. è´ªå©ªè§£ç ç¤ºä¾‹");
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

    let input_text = "The future of AI is";
    println!("è¾“å…¥: \"{}\"\n", input_text);

    // å°†æ–‡æœ¬è½¬æ¢ä¸º token IDsï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼Œå®é™…åº”è¯¥ä½¿ç”¨ tokenizerï¼‰
    let input_ids = tokenize_simple(input_text, &model);
    println!("Token IDs: {:?}\n", &input_ids[..input_ids.len().min(10)]);

    // è´ªå©ªç”Ÿæˆ
    println!("è´ªå©ªç”Ÿæˆï¼ˆé€‰æ‹©æ¦‚ç‡æœ€å¤§çš„ tokenï¼‰:");
    let start = std::time::Instant::now();
    let generated_greedy = model.generate(&input_ids, 10);
    let duration_greedy = start.elapsed();

    let output_text = detokenize_simple(&generated_greedy);
    println!("  ç”Ÿæˆ: \"{}\"", output_text);
    println!("  è€—æ—¶: {:.2}s\n", duration_greedy.as_secs_f32());

    // ============================================================================
    // 4. é‡‡æ ·ç”Ÿæˆç¤ºä¾‹
    // ============================================================================
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    println!("4. é‡‡æ ·ç”Ÿæˆç¤ºä¾‹");
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

    println!("ä¸åŒé‡‡æ ·ç­–ç•¥å¯¹æ¯”:");

    // æ¸©åº¦ = 0.7ï¼ˆé€‚åº¦éšæœºï¼‰
    println!("\n  a) Temperature = 0.7 (é€‚åº¦éšæœº):");
    let start = std::time::Instant::now();
    let generated_temp = model.generate_with_sampling(&input_ids, 10, 0.7, 0, 0.0);
    let output_temp = detokenize_simple(&generated_temp);
    let duration_temp = start.elapsed();
    println!("     ç”Ÿæˆ: \"{}\"", output_temp);
    println!("     è€—æ—¶: {:.2}s", duration_temp.as_secs_f32());

    // æ¸©åº¦ = 1.0ï¼ˆæ ‡å‡†éšæœºï¼‰
    println!("\n  b) Temperature = 1.0 (æ ‡å‡†éšæœº):");
    let start = std::time::Instant::now();
    let generated_temp1 = model.generate_with_sampling(&input_ids, 10, 1.0, 0, 0.0);
    let output_temp1 = detokenize_simple(&generated_temp1);
    let duration_temp1 = start.elapsed();
    println!("     ç”Ÿæˆ: \"{}\"", output_temp1);
    println!("     è€—æ—¶: {:.2}s", duration_temp1.as_secs_f32());

    // æ¸©åº¦ = 1.5ï¼ˆé«˜éšæœºæ€§ï¼‰
    println!("\n  c) Temperature = 1.5 (é«˜éšæœºæ€§):");
    let start = std::time::Instant::now();
    let generated_temp15 = model.generate_with_sampling(&input_ids, 10, 1.5, 0, 0.0);
    let output_temp15 = detokenize_simple(&generated_temp15);
    let duration_temp15 = start.elapsed();
    println!("     ç”Ÿæˆ: \"{}\"", output_temp15);
    println!("     è€—æ—¶: {:.2}s", duration_temp15.as_secs_f32());

    // ============================================================================
    // 5. Top-K å’Œ Top-p é‡‡æ ·
    // ============================================================================
    println!("\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    println!("5. Top-K å’Œ Top-p (Nucleus) é‡‡æ ·");
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

    println!("Top-K é‡‡æ ·ï¼ˆåªä»æ¦‚ç‡æœ€é«˜çš„ K ä¸ª token ä¸­é‡‡æ ·ï¼‰:");
    println!("  Top-K = 10:");
    let generated_topk = model.generate_with_sampling(&input_ids, 10, 1.0, 10, 0.0);
    println!("    ç”Ÿæˆ: \"{}\"\n", detokenize_simple(&generated_topk));

    println!("Top-p (Nucleus) é‡‡æ ·ï¼ˆåŠ¨æ€é€‰æ‹©ç´¯ç§¯æ¦‚ç‡è¾¾åˆ° p çš„æœ€å°é›†åˆï¼‰:");
    println!("  Top-p = 0.9:");
    let generated_topp = model.generate_with_sampling(&input_ids, 10, 1.0, 0, 0.9);
    println!("    ç”Ÿæˆ: \"{}\"\n", detokenize_simple(&generated_topp));

    println!("ç»„åˆä½¿ç”¨ (Temperature + Top-K + Top-p):");
    println!("  Temperature = 0.8, Top-K = 20, Top-p = 0.95:");
    let generated_combined = model.generate_with_sampling(&input_ids, 10, 0.8, 20, 0.95);
    println!("    ç”Ÿæˆ: \"{}\"\n", detokenize_simple(&generated_combined));

    // ============================================================================
    // 6. ä¸ä¼ ç»Ÿæ–¹æ³•å¯¹æ¯”
    // ============================================================================
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    println!("6. ä¸ä¼ ç»Ÿè¯­è¨€æ¨¡å‹å¯¹æ¯”");
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

    println!("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
    println!("â”‚ æ–¹æ³•             â”‚ æ¶æ„             â”‚ ä¼˜åŠ¿             â”‚ åŠ£åŠ¿             â”‚");
    println!("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤");
    println!("â”‚ RNN/LSTM        â”‚ é€’å½’             â”‚ åºåˆ—å¤„ç†è‡ªç„¶     â”‚ é•¿è·ç¦»ä¾èµ–å¼±     â”‚");
    println!("â”‚ Encoder-Decoder â”‚ ç¼–ç å™¨-è§£ç å™¨    â”‚ é€‚åˆç¿»è¯‘         â”‚ ç”Ÿæˆæ•ˆç‡ä½       â”‚");
    println!("â”‚ CausalLM        â”‚ Decoder-only     â”‚ ç”Ÿæˆæ•ˆç‡é«˜       â”‚ å•å‘æ³¨æ„åŠ›       â”‚");
    println!("â”‚ (GPT-2/3)       â”‚                  â”‚ å¹¶è¡Œè®­ç»ƒ         â”‚                 â”‚");
    println!("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n");

    // ============================================================================
    // 7. é‡‡æ ·ç­–ç•¥è¯¦è§£
    // ============================================================================
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    println!("7. é‡‡æ ·ç­–ç•¥è¯¦è§£");
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

    println!("1. Temperatureï¼ˆæ¸©åº¦ï¼‰:");
    println!("   - æ§åˆ¶è¾“å‡ºçš„éšæœºæ€§");
    println!("   - Temperature < 1.0: æ›´ä¿å®ˆï¼Œæ›´ç¡®å®š");
    println!("   - Temperature = 1.0: æ ‡å‡†éšæœºé‡‡æ ·");
    println!("   - Temperature > 1.0: æ›´éšæœºï¼Œæ›´å¤šæ ·");
    println!("   - å…¬å¼: logits = logits / temperature\n");

    println!("2. Top-K é‡‡æ ·:");
    println!("   - åªä»æ¦‚ç‡æœ€é«˜çš„ K ä¸ª token ä¸­é‡‡æ ·");
    println!("   - æ¨èå€¼: K = 40-50");
    println!("   - ä¼˜ç‚¹: è¿‡æ»¤æ‰ä½æ¦‚ç‡çš„åé€‰æ‹©");
    println!("   - ç¼ºç‚¹: K å¤ªå°ä¼šç¼ºä¹å¤šæ ·æ€§\n");

    println!("3. Top-p (Nucleus) é‡‡æ ·:");
    println!("   - åŠ¨æ€é€‰æ‹©ç´¯ç§¯æ¦‚ç‡è¾¾åˆ° p çš„æœ€å°é›†åˆ");
    println!("   - æ¨èå€¼: p = 0.9-0.95");
    println!("   - ä¼˜ç‚¹: è‡ªé€‚åº”é€‰æ‹©å€™é€‰é›†");
    println!("   - ç¼ºç‚¹: è®¡ç®—å¼€é”€ç¨å¤§\n");

    println!("4. æ¨èç»„åˆ:");
    println!("   - Temperature = 0.8");
    println!("   - Top-K = 40 (æˆ– Top-p = 0.95)");
    println!("   - è¿™ç§ç»„åˆåœ¨å¤šæ ·æ€§å’Œè´¨é‡ä¹‹é—´å–å¾—è‰¯å¥½å¹³è¡¡\n");

    // ============================================================================
    // 8. å®é™…åº”ç”¨å»ºè®®
    // ============================================================================
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    println!("8. å®é™…åº”ç”¨å»ºè®®");
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

    println!("1. åˆ›æ„å†™ä½œ:");
    println!("   - Temperature = 0.9-1.1");
    println!("   - Top-p = 0.95");
    println!("   - å¢åŠ åˆ›é€ æ€§å’Œå¤šæ ·æ€§\n");

    println!("2. äº‹å®é—®ç­”:");
    println!("   - Temperature = 0.5-0.7");
    println!("   - Top-K = 20");
    println!("   - å‡å°‘å¹»è§‰ï¼Œæé«˜å‡†ç¡®æ€§\n");

    println!("3. ä»£ç ç”Ÿæˆ:");
    println!("   - Temperature = 0.2-0.5");
    println!("   - Top-K = 10");
    println!("   - æ›´ç¡®å®šæ€§çš„è¾“å‡º\n");

    println!("4. å¯¹è¯ç³»ç»Ÿ:");
    println!("   - Temperature = 0.7-0.9");
    println!("   - Top-p = 0.9");
    println!("   - å¹³è¡¡è¿è´¯æ€§å’Œå¤šæ ·æ€§\n");

    println!("5. å®ç°ç¤ºä¾‹:");
    println!("```rust");
    println!("use mini_transformer::{{CausalLM, CausalLMConfig}};");
    println!();
    println!("// åˆ›å»ºæ¨¡å‹");
    println!("let config = CausalLMConfig::small();");
    println!("let model = CausalLM::new(config);");
    println!();
    println!("// è¾“å…¥æ–‡æœ¬");
    println!("let input_ids = vec
![1, 2, 3];");
    println!();
    println!("// è´ªå©ªç”Ÿæˆ");
    println!("let greedy = model.generate(&input_ids, 20);");
    println!();
    println!("// é‡‡æ ·ç”Ÿæˆ");
    println!("let sampled = model.generate_with_sampling(");
    println!("    &input_ids,");
    println!("    20,              // max_new_tokens");
    println!("    0.8,             // temperature");
    println!("    40,              // top_k");
    println!("    0.95             // top_p");
    println!(");");
    println!("```");

    println!();
    println!("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    println!("â•‘     ç¤ºä¾‹å®Œæˆï¼                               â•‘");
    println!("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

    println!("ğŸ’¡ å®è·µå»ºè®®:");
    println!("   - CausalLM æ˜¯ç°ä»£å¤§è¯­è¨€æ¨¡å‹çš„æ ¸å¿ƒæ¶æ„");
    println!("   - GPT-2, GPT-3, GPT-4 éƒ½ä½¿ç”¨è¿™ç§æ¶æ„");
    println!("   - é‡‡æ ·ç­–ç•¥å¯¹ç”Ÿæˆè´¨é‡å½±å“å¾ˆå¤§");
    println!("   - æ ¹æ®åº”ç”¨åœºæ™¯è°ƒæ•´å‚æ•°");
    println!("   - å®é™…åº”ç”¨éœ€è¦åœ¨å¤§è§„æ¨¡è¯­æ–™ä¸Šé¢„è®­ç»ƒ");
}

/// ç®€åŒ–çš„åˆ†è¯ï¼ˆä»…ç”¨äºæ¼”ç¤ºï¼‰
/// å®é™…åº”è¯¥ä½¿ç”¨ BPE æˆ–å…¶ä»–åˆ†è¯å™¨
fn tokenize_simple(text: &str, _model: &CausalLM) -> Vec<usize> {
    // ç®€å•åœ°å°†å­—ç¬¦è½¬æ¢ä¸º token IDs
    text.chars().map(|c| c as usize).collect()
}

/// ç®€åŒ–çš„å»åˆ†è¯ï¼ˆä»…ç”¨äºæ¼”ç¤ºï¼‰
fn detokenize_simple(token_ids: &[usize]) -> String {
    token_ids.iter()
        .filter_map(|&id| {
            if id <= 255 {
                Some(id as u8 as char)
            } else {
                Some('ï¿½') // æ›¿æ¢å­—ç¬¦
            }
        })
        .collect()
}
